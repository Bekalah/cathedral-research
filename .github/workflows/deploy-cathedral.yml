name: Deploy Cathedral Research to bekalah.github.io

on:
  push:
    branches: [main, master]
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  deploy-cathedral:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    
    steps:
      - name: 📥 Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive
          fetch-depth: 0

      - name: 🔧 Setup Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: 📦 Setup PNPM
        uses: pnpm/action-setup@v2
        with:
          version: latest

      - name: 🏗️ Install Dependencies
        run: pnpm install --frozen-lockfile

      - name: 🔍 Quality Verification
        run: |
          echo "🏛️ Verifying museum-quality standards..."
          if [ -f "devops/protect-check.js" ]; then
            node devops/protect-check.js
          fi
          echo "✅ Sophisticated aesthetics preserved"

      - name: 🎭 Build Character System
        run: |
          echo "🎭 Building complete Liber Arcanae character system..."
          pnpm run characters:build
          echo "✅ 22 Major Arcana characters ready for deployment"

      - name: 📦 Build Packages
        run: |
          echo "📦 Building all packages..."
          pnpm run build:packages
          echo "✅ All sophisticated packages built"

      - name: 🏛️ Build Applications
        run: |
          echo "🏛️ Building all Cathedral Research applications..."
          pnpm run build:apps
          echo "✅ All sophisticated applications built"

      - name: 📁 Prepare GitHub Pages Deployment
        run: |
          echo "📁 Preparing deployment structure..."
          mkdir -p gh-pages-deployment
          
          # Copy Cathedral Hub as main entry point
          if [ -d "apps/cathedral-hub/dist" ]; then
            echo "Copying Cathedral Hub..."
            cp -r apps/cathedral-hub/dist/* gh-pages-deployment/
          fi
          
          # Create app subdirectories and copy builds
          mkdir -p gh-pages-deployment/{cathedral,grimoire,lab,studio,cyoa}
          
          if [ -d "apps/cathedral-of-circuits/dist" ]; then
            cp -r apps/cathedral-of-circuits/dist/* gh-pages-deployment/cathedral/
          fi
          
          if [ -d "apps/stone-grimoire/dist" ]; then
            cp -r apps/stone-grimoire/dist/* gh-pages-deployment/grimoire/
          fi
          
          if [ -d "apps/arcanae-lab/dist" ]; then
            cp -r apps/arcanae-lab/dist/* gh-pages-deployment/lab/
          fi
          
          if [ -d "apps/synth-art-studio/dist" ]; then
            cp -r apps/synth-art-studio/dist/* gh-pages-deployment/studio/
          fi
          
          if [ -d "apps/cyoa-engine/dist" ]; then
            cp -r apps/cyoa-engine/dist/* gh-pages-deployment/cyoa/
          fi
          
          # Copy character system and registry
          if [ -d "shared/characters" ]; then
            mkdir -p gh-pages-deployment/characters
            cp -r shared/characters/* gh-pages-deployment/characters/
          fi
          
          if [ -d "registry" ]; then
            mkdir -p gh-pages-deployment/registry
            cp -r registry/* gh-pages-deployment/registry/
          fi
          
          if [ -d "assets" ]; then
            mkdir -p gh-pages-deployment/assets
            cp -r assets/* gh-pages-deployment/assets/
          fi
          
          # Create fallback index.html if none exists
          if [ ! -f "gh-pages-deployment/index.html" ]; then
            echo "Creating fallback index.html..."
            cat > gh-pages-deployment/index.html << 'EOF'
          <!DOCTYPE html>
          <html lang="en">
          <head>
            <meta charset="UTF-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <title>🏛️ Cathedral Research - Rebecca Lemke</title>
            <style>
              body {
                font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
                margin: 0;
                padding: 2rem;
                background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
                color: #ffffff;
                min-height: 100vh;
                display: flex;
                flex-direction: column;
                align-items: center;
                justify-content: center;
              }
              .cathedral-logo {
                font-size: 4rem;
                margin-bottom: 1rem;
              }
              .title {
                font-size: 2.5rem;
                margin-bottom: 1rem;
                text-align: center;
                background: linear-gradient(45deg, #ffd700, #ffed4e);
                -webkit-background-clip: text;
                -webkit-text-fill-color: transparent;
              }
              .description {
                font-size: 1.2rem;
                text-align: center;
                margin-bottom: 3rem;
                opacity: 0.9;
                max-width: 600px;
              }
              .apps-grid {
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
                gap: 1.5rem;
                width: 100%;
                max-width: 1200px;
              }
              .app-card {
                background: rgba(255, 255, 255, 0.1);
                backdrop-filter: blur(10px);
                border: 1px solid rgba(255, 255, 255, 0.2);
                border-radius: 15px;
                padding: 1.5rem;
                text-align: center;
                transition: transform 0.3s ease;
                cursor: pointer;
              }
              .app-card:hover {
                transform: translateY(-5px);
                background: rgba(255, 255, 255, 0.15);
              }
              .app-icon {
                font-size: 3rem;
                margin-bottom: 1rem;
              }
              .app-name {
                font-size: 1.3rem;
                margin-bottom: 0.5rem;
                color: #ffd700;
              }
              .app-description {
                opacity: 0.8;
                line-height: 1.4;
              }
            </style>
          </head>
          <body>
            <div class="cathedral-logo">🏛️</div>
            <h1 class="title">Cathedral Research</h1>
            <p class="description">
              Mystical computing, AI-enhanced esoteric systems, and consciousness exploration
              by Rebecca Susan Lemke
            </p>
            
            <div class="apps-grid">
              <div class="app-card" onclick="window.location='/cathedral'">
                <div class="app-icon">🏛️</div>
                <div class="app-name">Cathedral of Circuits</div>
                <div class="app-description">Main experience engine</div>
              </div>
              
              <div class="app-card" onclick="window.location='/grimoire'">
                <div class="app-icon">📜</div>
                <div class="app-name">Stone Grimoire</div>
                <div class="app-description">Mystical creation tools</div>
              </div>
              
              <div class="app-card" onclick="window.location='/lab'">
                <div class="app-icon">🔬</div>
                <div class="app-name">Arcanae Lab</div>
                <div class="app-description">Research and development</div>
              </div>
              
              <div class="app-card" onclick="window.location='/studio'">
                <div class="app-icon">🎵</div>
                <div class="app-name">Synth Art Studio</div>
                <div class="app-description">Audio-visual synthesis</div>
              </div>
              
              <div class="app-card" onclick="window.location='/cyoa'">
                <div class="app-icon">🎮</div>
                <div class="app-name">CYOA Engine</div>
                <div class="app-description">Choose Your Own Adventure</div>
              </div>
              
              <div class="app-card" onclick="window.location='/characters'">
                <div class="app-icon">🎭</div>
                <div class="app-name">Liber Arcanae</div>
                <div class="app-description">22 Major Arcana characters</div>
              </div>
            </div>
          </body>
          </html>
          EOF
          fi
          
          echo "✅ Deployment structure prepared with museum quality preserved"

      - name: 🌐 Setup GitHub Pages
        uses: actions/configure-pages@v4

      - name: 📤 Upload Pages Artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: './gh-pages-deployment'

      - name: 🚀 Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4