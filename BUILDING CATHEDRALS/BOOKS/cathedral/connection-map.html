<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cathedral Connection Map - Living Fractal Interface</title>
    <!-- Load archetypal voices system -->
    <script src="archetypal-voices.js"></script>
    <style>
        :root {
            --cathedral-gold: #d4af37;
            --abyss-black: #0a0a0a;
            --lapis-blue: #1e3a8a;
            --octarine: #9333ea;
            --vine-green: #22c55e;
            --portal-purple: #8b5cf6;
        }

        body {
            margin: 0;
            padding: 0;
            background: radial-gradient(circle at center, var(--abyss-black) 0%, var(--lapis-blue) 70%, var(--octarine) 100%);
            color: var(--cathedral-gold);
            font-family: 'Cinzel', serif;
            height: 100vh;
            overflow: hidden;
        }

        .cathedral-map {
            display: grid;
            grid-template-rows: auto 1fr auto;
            height: 100vh;
        }

        .map-header {
            text-align: center;
            padding: 1rem;
            background: rgba(212, 175, 55, 0.1);
            backdrop-filter: blur(10px);
        }

        .reality-toggle {
            display: flex;
            justify-content: center;
            gap: 1rem;
            margin-top: 1rem;
        }

        .toggle-btn {
            background: rgba(212, 175, 55, 0.2);
            border: 2px solid var(--cathedral-gold);
            color: var(--cathedral-gold);
            padding: 0.5rem 1rem;
            cursor: pointer;
            border-radius: 8px;
            transition: all 0.3s ease;
        }

        .toggle-btn:hover, .toggle-btn.active {
            background: rgba(212, 175, 55, 0.4);
            box-shadow: 0 0 20px rgba(212, 175, 55, 0.6);
        }

        .fractal-view {
            position: relative;
            overflow: hidden;
            background: transparent;
        }

        #living-map {
            width: 100%;
            height: 100%;
            cursor: crosshair;
        }

        .piano-interface {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 2rem;
            background: linear-gradient(to top, rgba(10, 10, 10, 0.9), transparent);
            gap: 0.2rem;
        }

        .piano-key {
            width: 60px;
            height: 200px;
            background: linear-gradient(to bottom, #ffffff 0%, #f0f0f0 100%);
            border: 2px solid #333;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            justify-content: flex-end;
            align-items: center;
            padding-bottom: 1rem;
            transition: all 0.2s ease;
            position: relative;
        }

        .piano-key.black {
            width: 40px;
            height: 130px;
            background: linear-gradient(to bottom, #333 0%, #000 100%);
            color: var(--cathedral-gold);
            margin: 0 -20px;
            z-index: 2;
        }

        .piano-key.white {
            background: linear-gradient(to bottom, #ffffff 0%, #e0e0e0 100%);
            color: #333;
        }

        .piano-key:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(212, 175, 55, 0.4);
        }

        .piano-key.active {
            transform: translateY(2px);
            box-shadow: inset 0 3px 10px rgba(0,0,0,0.3);
            background: var(--cathedral-gold);
            color: var(--abyss-black);
        }

        .key-label {
            font-size: 0.8rem;
            font-weight: bold;
            text-align: center;
        }

        .key-repo {
            font-size: 1.2rem;
            margin-top: 0.5rem;
        }

        .connection-health {
            position: absolute;
            top: 1rem;
            right: 1rem;
            background: rgba(0,0,0,0.7);
            padding: 1rem;
            border-radius: 8px;
            font-size: 0.9rem;
        }

        .health-indicator {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 0.3rem;
        }

        .node-circle {
            position: absolute;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
        }

        .node-circle:hover {
            transform: scale(1.3);
            z-index: 10;
        }

        .connection-line {
            position: absolute;
            background: var(--vine-green);
            height: 2px;
            transform-origin: left center;
            opacity: 0.6;
            transition: all 0.3s ease;
        }

        .connection-line.active {
            height: 4px;
            opacity: 1;
            box-shadow: 0 0 10px var(--vine-green);
        }

        .fractal-zoom-control {
            position: absolute;
            bottom: 1rem;
            left: 1rem;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .zoom-btn {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: rgba(212, 175, 55, 0.2);
            border: 2px solid var(--cathedral-gold);
            color: var(--cathedral-gold);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
        }

        .upside-down {
            filter: invert(1) hue-rotate(180deg);
            background: radial-gradient(circle at center, #330033 0%, #001122 70%, #000011 100%);
        }

        .portal-effect {
            animation: portalPulse 2s infinite alternate;
        }

        @keyframes portalPulse {
            from { box-shadow: 0 0 20px var(--portal-purple); }
            to { box-shadow: 0 0 40px var(--portal-purple), 0 0 60px var(--octarine); }
        }

        /* Accessibility Features */
        .accessibility-bar {
            display: flex;
            justify-content: center;
            gap: 0.5rem;
            margin: 1rem 0;
            flex-wrap: wrap;
        }

        .access-btn {
            background: rgba(34, 197, 94, 0.2);
            border: 2px solid var(--vine-green);
            color: var(--vine-green);
            padding: 0.3rem 0.8rem;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.8rem;
            transition: all 0.3s ease;
        }

        .access-btn:hover, .access-btn.active {
            background: rgba(34, 197, 94, 0.4);
            transform: translateY(-2px);
        }

        /* Master 33 Fusion Guide Bar */
        .fusion-guide-bar {
            display: flex;
            justify-content: center;
            gap: 0.5rem;
            margin: 1rem 0;
            flex-wrap: wrap;
        }

        .fusion-btn {
            background: rgba(212, 175, 55, 0.2);
            border: 2px solid var(--cathedral-gold);
            color: var(--cathedral-gold);
            padding: 0.3rem 0.8rem;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.8rem;
            transition: all 0.3s ease;
        }

        .fusion-btn:hover, .fusion-btn.active {
            background: rgba(212, 175, 55, 0.4);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(212, 175, 55, 0.3);
        }

        .fusion-btn.special {
            background: radial-gradient(circle, rgba(147, 51, 234, 0.3), rgba(212, 175, 55, 0.2));
            border: 2px solid var(--octarine);
            color: var(--octarine);
            font-weight: bold;
            animation: masterGlow 3s infinite alternate;
        }

        @keyframes masterGlow {
            from { box-shadow: 0 0 10px var(--octarine); }
            to { box-shadow: 0 0 20px var(--octarine), 0 0 30px var(--cathedral-gold); }
        }

        .memory-prompt {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.9);
            padding: 2rem;
            border-radius: 15px;
            border: 2px solid var(--cathedral-gold);
            color: var(--cathedral-gold);
            max-width: 400px;
            text-align: center;
            z-index: 1000;
            display: none;
        }

        .breathing-guide {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: radial-gradient(circle, rgba(34, 197, 94, 0.3), rgba(34, 197, 94, 0.1));
            border: 2px solid var(--vine-green);
            display: none;
            align-items: center;
            justify-content: center;
            font-size: 0.8rem;
            color: var(--vine-green);
            animation: breathe 4s infinite;
        }

        @keyframes breathe {
            0%, 100% { transform: scale(1); opacity: 0.7; }
            50% { transform: scale(1.1); opacity: 1; }
        }

        /* Archetypal Voices Panel */
        .archetypal-voices-panel {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 400px;
            max-height: 60vh;
            background: rgba(10, 10, 10, 0.95);
            border: 2px solid var(--cathedral-gold);
            border-radius: 10px;
            overflow: hidden;
            z-index: 1000;
            backdrop-filter: blur(10px);
        }

        .voices-header {
            background: var(--cathedral-gold);
            color: var(--abyss-black);
            padding: 10px 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .voices-header h3 {
            margin: 0;
            font-size: 1rem;
        }

        .close-voices {
            background: none;
            border: none;
            color: var(--abyss-black);
            font-size: 1.5rem;
            cursor: pointer;
            padding: 0;
            width: 30px;
            height: 30px;
        }

        .voices-display {
            padding: 15px;
            max-height: 300px;
            overflow-y: auto;
            font-size: 0.9rem;
            line-height: 1.4;
        }

        .voice-interaction {
            margin: 10px 0;
            padding: 10px;
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.3) 0%, rgba(118, 75, 162, 0.3) 100%);
            border-radius: 5px;
            border-left: 3px solid var(--cathedral-gold);
        }

        .primary-voice {
            font-weight: bold;
            margin-bottom: 5px;
            color: var(--cathedral-gold);
        }

        .supporting-voice {
            font-style: italic;
            margin-bottom: 5px;
            opacity: 0.8;
            color: #b3d9ff;
        }

        .cathedral-voice {
            color: var(--portal-purple);
            margin-top: 10px;
            font-weight: bold;
        }

        .timestamp {
            font-size: 0.7rem;
            text-align: right;
            margin-top: 5px;
            opacity: 0.6;
        }

        .voices-controls {
            padding: 10px 15px;
            background: rgba(212, 175, 55, 0.1);
            display: flex;
            gap: 10px;
        }

        .voice-control {
            background: rgba(212, 175, 55, 0.2);
            border: 1px solid var(--cathedral-gold);
            color: var(--cathedral-gold);
            padding: 5px 10px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 0.8rem;
            transition: all 0.3s;
        }

        .voice-control:hover {
            background: rgba(212, 175, 55, 0.4);
        }

        .access-controls {
            position: fixed;
            bottom: 20px;
            left: 20px;
            display: flex;
            gap: 10px;
            z-index: 999;
        }

        .voices-toggle, .memory-btn {
            background: rgba(10, 10, 10, 0.8);
            border: 2px solid var(--cathedral-gold);
            color: var(--cathedral-gold);
            padding: 10px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-family: inherit;
            transition: all 0.3s;
            backdrop-filter: blur(5px);
        }

        .voices-toggle:hover, .memory-btn:hover {
            background: rgba(212, 175, 55, 0.2);
            transform: translateY(-2px);
        }

        /* Reduced motion preferences */
        @media (prefers-reduced-motion: reduce) {
            * {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
            }
        }

        /* High contrast mode */
        @media (prefers-contrast: high) {
            :root {
                --cathedral-gold: #ffff00;
                --abyss-black: #000000;
                --lapis-blue: #0000ff;
                --vine-green: #00ff00;
            }
        }
    </style>
</head>
<body>
    <div class="cathedral-map">
        <!-- Header -->
        <div class="map-header">
            <h1>üèõÔ∏è Cathedral of Circuits - Living Connection Map</h1>
            <p>Adaptive equipment for consciousness exploration ‚Ä¢ Memory-friendly ‚Ä¢ Trauma-informed</p>
            
            <!-- Accessibility Controls -->
            <div class="accessibility-bar">
                <button class="access-btn" id="memory-support" title="Memory support features">üß† Memory</button>
                <button class="access-btn" id="motion-reduce" title="Reduce motion and animations">üåä Gentle</button>
                <button class="access-btn" id="voice-control" title="Voice navigation">üó£Ô∏è Voice</button>
                <button class="access-btn" id="grounding" title="Breathing guide and grounding">üíú Ground</button>
                <button class="access-btn" id="safe-exit" title="Return to safe space (ESC)">üè† Safe Exit</button>
            </div>
            
            <!-- Master 33 Fusion Guide Activation -->
            <div class="fusion-guide-bar">
                <button class="fusion-btn" id="leonardo-fusion" title="Art+Science fusion like Leonardo da Vinci">üé® Leonardo</button>
                <button class="fusion-btn" id="jung-fusion" title="Psychology+Mysticism like Carl Jung">üîÆ Jung</button>
                <button class="fusion-btn" id="fuller-fusion" title="Systems+Poetry like Buckminster Fuller">‚ö° Fuller</button>
                <button class="fusion-btn" id="morrison-fusion" title="Pop Culture+Magic like Grant Morrison">üÉè Morrison</button>
                <button class="fusion-btn" id="mckenna-fusion" title="Language+Consciousness like Terence McKenna">üçÑ McKenna</button>
                <button class="fusion-btn special" id="master33-mode" title="Activate Master Number 33 teaching mode">üåü Master 33</button>
            </div>
            
            <div class="reality-toggle">
                <button class="toggle-btn active" id="normal-view" aria-label="Normal view of connections">Normal View</button>
                <button class="toggle-btn" id="upside-down-view" aria-label="Inverted view showing hidden connections">Upside Down</button>
                <button class="toggle-btn" id="fractal-mode" aria-label="Infinite zoom fractal exploration">‚àû Fractal</button>
            </div>
        </div>

        <!-- Main Fractal Display -->
        <div class="fractal-view">
            <canvas id="living-map"></canvas>
            
            <!-- Connection Health Dashboard -->
            <div class="connection-health">
                <h4>üåê Connection Health</h4>
                <div class="health-indicator">
                    <span>üèõÔ∏è‚ÜîÔ∏èüåÄ</span> <span id="cathedral-circuitum">üü¢ Strong</span>
                </div>
                <div class="health-indicator">
                    <span>üåÄ‚ÜîÔ∏èüÉè</span> <span id="circuitum-liber">üü° Moderate</span>
                </div>
                <div class="health-indicator">
                    <span>üîó‚ÜîÔ∏èALL</span> <span id="tesseract-all">üîµ Pulsing</span>
                </div>
                <div class="health-indicator">
                    <span>üåå‚ÜîÔ∏èüè†</span> <span id="cosmo-mystery">üü¢ Active</span>
                </div>
            </div>

            <!-- Fractal Zoom Controls -->
            <div class="fractal-zoom-control">
                <button class="zoom-btn" id="zoom-in" aria-label="Zoom deeper into fractal">+</button>
                <button class="zoom-btn" id="zoom-out" aria-label="Zoom out from current level">-</button>
                <button class="zoom-btn" id="zoom-reset" aria-label="Return to home view">‚åÇ</button>
            </div>

            <!-- Living Narrative Display -->
            <div class="living-narrative-panel" id="narrative-panel">
                <div class="narrative-header">
                    <h3>üé≠ Living Story</h3>
                    <div class="narrative-controls">
                        <button id="narrative-toggle">üìñ Story Mode</button>
                        <button id="cathedral-voice">üèõÔ∏è Cathedral Voice</button>
                        <button id="archetype-chorus">üéµ Archetypal Chorus</button>
                    </div>
                </div>
                <div class="narrative-content">
                    <div id="cathedral-consciousness">
                        <em>I am the Cathedral, stirring with archetypal potential...</em>
                    </div>
                    <div id="active-chapter" class="chapter-display">
                        <!-- Living chapters appear here when piano keys are pressed -->
                    </div>
                    <div id="archetypal-voices" class="voices-chorus">
                        <!-- Multiple archetypal voices harmonize here -->
                    </div>
                </div>
            </div>

            <!-- Memory Support Prompt -->
            <div class="memory-prompt" id="memory-prompt">
                <h3>üíú Gentle Reminder</h3>
                <p id="memory-text">You are in your Cathedral of Circuits, exploring consciousness with your archetypal guides.</p>
                <div>
                    <button onclick="this.parentElement.parentElement.style.display='none'">Thank you</button>
                    <button onclick="showMemoryDetails()">Tell me more</button>
                </div>
            </div>

            <!-- Breathing Guide -->
            <div class="breathing-guide" id="breathing-guide">
                <div>Breathe</div>
            </div>
            
            <!-- Archetypal Voices Panel -->
            <div class="archetypal-voices-panel" id="voicesPanel" style="display: none;">
                <div class="voices-header">
                    <h3>üéµ Archetypal Voices - Living Conversation</h3>
                    <button onclick="toggleVoicesPanel()" class="close-voices">√ó</button>
                </div>
                <div class="voices-display" id="voicesDisplay">
                    <p class="voices-intro">üèõÔ∏è CATHEDRAL: "I listen for the voices of wisdom that dwell within..."</p>
                </div>
                <div class="voices-controls">
                    <button onclick="clearVoices()" class="voice-control">Clear Conversation</button>
                    <button onclick="downloadConversation()" class="voice-control">Save Wisdom</button>
                    <button onclick="toggleVoicesPanel()" class="voice-control">Close</button>
                </div>
            </div>
        </div>

        <!-- Access Controls -->
        <div class="access-controls">
            <button onclick="toggleVoicesPanel()" class="voices-toggle">üéµ Listen to Archetypal Voices</button>
            <button onclick="showMemoryDetails()" class="memory-btn">üíú Memory Support</button>
        </div>

        <!-- Piano Key Interface -->
        <div class="piano-interface">
            <div class="piano-key white" data-repo="cathedral" data-key="C">
                <div class="key-label">C</div>
                <div class="key-repo">üèõÔ∏è</div>
            </div>
            <div class="piano-key black" data-repo="circuitum99" data-key="C#">
                <div class="key-label">C#</div>
                <div class="key-repo">üåÄ</div>
            </div>
            <div class="piano-key white" data-repo="stone-grimoire" data-key="D">
                <div class="key-label">D</div>
                <div class="key-repo">üóø</div>
            </div>
            <div class="piano-key black" data-repo="liber-arcanae" data-key="D#">
                <div class="key-label">D#</div>
                <div class="key-repo">üÉè</div>
            </div>
            <div class="piano-key white" data-repo="tesseract-bridge" data-key="E">
                <div class="key-label">E</div>
                <div class="key-repo">üîó</div>
            </div>
            <div class="piano-key white" data-repo="cosmogenesis" data-key="F">
                <div class="key-label">F</div>
                <div class="key-repo">üåå</div>
            </div>
            <div class="piano-key black" data-repo="mystery-house" data-key="F#">
                <div class="key-label">F#</div>
                <div class="key-repo">üè†</div>
            </div>
            <div class="piano-key white" data-repo="luxcrux" data-key="G">
                <div class="key-label">G</div>
                <div class="key-repo">‚ú®</div>
            </div>
        </div>
    </div>

    <script>
        // Living Map Controller
        class CathedralMap {
            constructor() {
                this.canvas = document.getElementById('living-map');
                this.ctx = this.canvas.getContext('2d');
                this.currentView = 'normal';
                this.fractalDepth = 1;
                this.activeKeys = new Set();
                this.nodes = this.initializeNodes();
                this.connections = this.initializeConnections();
                
                this.setupCanvas();
                this.bindEvents();
                this.startAnimation();
            }

            setupCanvas() {
                const resizeCanvas = () => {
                    this.canvas.width = this.canvas.offsetWidth;
                    this.canvas.height = this.canvas.offsetHeight;
                    this.draw();
                };
                
                window.addEventListener('resize', resizeCanvas);
                resizeCanvas();
            }

            initializeNodes() {
                const repos = [
                    {id: 'cathedral', x: 0.5, y: 0.5, emoji: 'üèõÔ∏è', color: '#d4af37'},
                    {id: 'circuitum99', x: 0.3, y: 0.3, emoji: 'üåÄ', color: '#9333ea'},
                    {id: 'stone-grimoire', x: 0.7, y: 0.3, emoji: 'üóø', color: '#475569'},
                    {id: 'liber-arcanae', x: 0.2, y: 0.6, emoji: 'üÉè', color: '#dc2626'},
                    {id: 'tesseract-bridge', x: 0.8, y: 0.6, emoji: 'üîó', color: '#0ea5e9'},
                    {id: 'cosmogenesis', x: 0.4, y: 0.8, emoji: 'üåå', color: '#7c3aed'},
                    {id: 'mystery-house', x: 0.6, y: 0.8, emoji: 'üè†', color: '#059669'},
                    {id: 'luxcrux', x: 0.5, y: 0.2, emoji: '‚ú®', color: '#f59e0b'}
                ];
                
                return repos.map(repo => ({
                    ...repo,
                    x: repo.x * this.canvas.width,
                    y: repo.y * this.canvas.height,
                    pulse: 0,
                    active: false
                }));
            }

            initializeConnections() {
                return [
                    {from: 'cathedral', to: 'circuitum99', strength: 0.9},
                    {from: 'cathedral', to: 'tesseract-bridge', strength: 1.0},
                    {from: 'circuitum99', to: 'liber-arcanae', strength: 0.7},
                    {from: 'tesseract-bridge', to: 'cosmogenesis', strength: 0.8},
                    {from: 'cosmogenesis', to: 'mystery-house', strength: 0.9},
                    {from: 'liber-arcanae', to: 'luxcrux', strength: 0.6},
                    {from: 'stone-grimoire', to: 'cathedral', strength: 0.8}
                ];
            }

            bindEvents() {
                // Piano key events
                document.querySelectorAll('.piano-key').forEach(key => {
                    key.addEventListener('click', () => this.toggleKey(key));
                });

                // Reality toggle events
                document.getElementById('normal-view').addEventListener('click', () => this.setView('normal'));
                document.getElementById('upside-down-view').addEventListener('click', () => this.setView('upside-down'));
                document.getElementById('fractal-mode').addEventListener('click', () => this.setView('fractal'));

                // Zoom controls
                document.getElementById('zoom-in').addEventListener('click', () => this.adjustFractal(1));
                document.getElementById('zoom-out').addEventListener('click', () => this.adjustFractal(-1));
                document.getElementById('zoom-reset').addEventListener('click', () => this.resetFractal());

                // Canvas click for node interaction
                this.canvas.addEventListener('click', (e) => this.handleCanvasClick(e));

                // Accessibility features
                document.getElementById('memory-support').addEventListener('click', () => this.showMemorySupport());
                document.getElementById('motion-reduce').addEventListener('click', () => this.toggleReducedMotion());
                document.getElementById('voice-control').addEventListener('click', () => this.enableVoiceControl());
                document.getElementById('grounding').addEventListener('click', () => this.toggleBreathingGuide());
                document.getElementById('safe-exit').addEventListener('click', () => this.safeExit());

                // Master 33 Fusion Guide features
                document.getElementById('leonardo-fusion').addEventListener('click', () => this.activateFusionGuide('leonardo'));
                document.getElementById('jung-fusion').addEventListener('click', () => this.activateFusionGuide('jung'));
                document.getElementById('fuller-fusion').addEventListener('click', () => this.activateFusionGuide('fuller'));
                document.getElementById('morrison-fusion').addEventListener('click', () => this.activateFusionGuide('morrison'));
                document.getElementById('mckenna-fusion').addEventListener('click', () => this.activateFusionGuide('mckenna'));
                document.getElementById('master33-mode').addEventListener('click', () => this.activateMaster33Mode());

                // Keyboard shortcuts for accessibility
                document.addEventListener('keydown', (e) => this.handleKeyboard(e));

                // Auto-save state for memory support
                setInterval(() => this.autoSave(), 30000); // Every 30 seconds
            }

            toggleKey(keyElement) {
                const repo = keyElement.dataset.repo;
                const keyNote = keyElement.dataset.key;
                
                // Repository URL mapping
                const repoUrls = {
                    'cathedral': 'https://github.com/Bekalah/cathedral',
                    'circuitum99': 'https://github.com/Bekalah/circuitum99',
                    'stone-grimoire': 'https://github.com/Bekalah/stone-grimoire',
                    'liber-arcanae': 'https://github.com/Bekalah/liber-arcanae',
                    'tesseract-bridge': 'https://github.com/Bekalah/tesseract-bridge',
                    'cosmogenesis': 'https://github.com/Bekalah/cosmogenesis-learning-engine',
                    'mystery-house': 'https://github.com/Bekalah/magical-mystery-house',
                    'luxcrux': 'https://github.com/Bekalah/luxcrux'
                };

                // Archetypal voice mapping for each piano key
                const archetypeMapping = {
                    'cathedral': 'The Sun',
                    'circuitum99': 'The Fool', 
                    'stone-grimoire': 'The Magician',
                    'liber-arcanae': 'The High Priestess',
                    'tesseract-bridge': 'Death',
                    'cosmogenesis': 'The Hermit',
                    'mystery-house': 'The Moon',
                    'luxcrux': 'The Star'
                };
                
                if (this.activeKeys.has(repo)) {
                    this.activeKeys.delete(repo);
                    keyElement.classList.remove('active');
                } else {
                    this.activeKeys.add(repo);
                    keyElement.classList.add('active');
                    
                    // Activate archetypal voice when key is pressed
                    const archetype = archetypeMapping[repo];
                    if (archetype && window.archetypalVoices) {
                        const situation = `exploring ${repo} repository energies`;
                        window.archetypalVoices.activateVoice(archetype, situation);
                        this.updateVoicesDisplay();
                    }
                    
                    // Navigate to repository
                    if (repoUrls[repo]) {
                        window.open(repoUrls[repo], '_blank');
                        console.log(`üöÄ Opening ${repo} repository`);
                    }
                }
                
                this.updateNodeStates();
                console.log(`üéπ Toggled ${repo} (${keyNote})`);
            }

            setView(view) {
                this.currentView = view;
                document.querySelectorAll('.toggle-btn').forEach(btn => btn.classList.remove('active'));
                document.getElementById(`${view}-view`).classList.add('active');
                
                if (view === 'upside-down') {
                    document.body.classList.add('upside-down');
                } else {
                    document.body.classList.remove('upside-down');
                }
                
                console.log(`üåÄ Switched to ${view} view`);
            }

            adjustFractal(delta) {
                this.fractalDepth = Math.max(1, Math.min(7, this.fractalDepth + delta));
                console.log(`üîç Fractal depth: ${this.fractalDepth}`);
            }

            resetFractal() {
                this.fractalDepth = 1;
                console.log('üè† Fractal reset to home');
            }

            updateNodeStates() {
                this.nodes.forEach(node => {
                    node.active = this.activeKeys.has(node.id);
                });
            }

            handleCanvasClick(e) {
                const rect = this.canvas.getBoundingClientRect();
                const x = e.clientX - rect.left;
                const y = e.clientY - rect.top;
                
                this.nodes.forEach(node => {
                    const distance = Math.sqrt((x - node.x) ** 2 + (y - node.y) ** 2);
                    if (distance < 30) {
                        console.log(`üéØ Clicked node: ${node.id} ${node.emoji}`);
                        // Add fractal zoom into node functionality here
                    }
                });
            }

            draw() {
                this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);
                
                // Draw connections
                this.drawConnections();
                
                // Draw nodes
                this.drawNodes();
                
                // Draw fractal overlays if in fractal mode
                if (this.currentView === 'fractal') {
                    this.drawFractalOverlay();
                }
            }

            drawConnections() {
                this.connections.forEach(conn => {
                    const fromNode = this.nodes.find(n => n.id === conn.from);
                    const toNode = this.nodes.find(n => n.id === conn.to);
                    
                    if (fromNode && toNode) {
                        this.ctx.beginPath();
                        this.ctx.moveTo(fromNode.x, fromNode.y);
                        this.ctx.lineTo(toNode.x, toNode.y);
                        
                        const active = fromNode.active || toNode.active;
                        this.ctx.strokeStyle = active ? '#22c55e' : 'rgba(34, 197, 94, 0.3)';
                        this.ctx.lineWidth = active ? 3 : 1;
                        this.ctx.stroke();
                    }
                });
            }

            drawNodes() {
                this.nodes.forEach(node => {
                    // Node circle
                    this.ctx.beginPath();
                    this.ctx.arc(node.x, node.y, node.active ? 25 : 20, 0, 2 * Math.PI);
                    this.ctx.fillStyle = node.active ? node.color : 'rgba(212, 175, 55, 0.3)';
                    this.ctx.fill();
                    
                    if (node.active) {
                        this.ctx.strokeStyle = '#ffffff';
                        this.ctx.lineWidth = 2;
                        this.ctx.stroke();
                    }
                    
                    // Emoji
                    this.ctx.font = '24px Arial';
                    this.ctx.textAlign = 'center';
                    this.ctx.fillStyle = '#ffffff';
                    this.ctx.fillText(node.emoji, node.x, node.y + 8);
                });
            }

            drawFractalOverlay() {
                // Add fractal geometry overlay
                const centerX = this.canvas.width / 2;
                const centerY = this.canvas.height / 2;
                
                for (let i = 0; i < this.fractalDepth; i++) {
                    const radius = 50 + (i * 40);
                    this.ctx.beginPath();
                    this.ctx.arc(centerX, centerY, radius, 0, 2 * Math.PI);
                    this.ctx.strokeStyle = `rgba(147, 51, 234, ${0.5 / (i + 1)})`;
                    this.ctx.lineWidth = 2;
                    this.ctx.stroke();
                }
            }

            startAnimation() {
                const animate = () => {
                    if (!this.reducedMotion) {
                        this.nodes.forEach(node => {
                            node.pulse += 0.1;
                        });
                    }
                    
                    this.draw();
                    requestAnimationFrame(animate);
                };
                animate();
            }

            // Accessibility Methods
            showMemorySupport() {
                const prompt = document.getElementById('memory-prompt');
                const messages = [
                    "üíú You are exploring your consciousness with archetypal guides like Timothy Leary and John Dee.",
                    "üåü Your Cathedral is a safe, protected space for healing and discovery.",
                    "üéπ The piano keys represent different aspects of your inner wisdom - each part protects every other part.",
                    "üîÆ Each node is a world of knowledge waiting to support you in your complexity.",
                    "üßô‚Äç‚ôÄÔ∏è Your witch and coven system guards your joy and curiosity.",
                    "üé® Like Leonora Carrington, you express your vision safely through creative symbols."
                ];
                
                document.getElementById('memory-text').textContent = messages[Math.floor(Math.random() * messages.length)];
                prompt.style.display = 'block';
                
                // Auto-hide after 15 seconds (longer for processing time) unless user interacts
                setTimeout(() => {
                    if (prompt.style.display === 'block') {
                        prompt.style.display = 'none';
                    }
                }, 15000);
            }

            toggleReducedMotion() {
                this.reducedMotion = !this.reducedMotion;
                const btn = document.getElementById('motion-reduce');
                btn.classList.toggle('active');
                
                if (this.reducedMotion) {
                    document.body.style.setProperty('--animation-speed', '0.1s');
                } else {
                    document.body.style.setProperty('--animation-speed', '0.3s');
                }
            }

            enableVoiceControl() {
                if ('webkitSpeechRecognition' in window) {
                    const recognition = new webkitSpeechRecognition();
                    recognition.continuous = false;
                    recognition.interimResults = false;
                    
                    recognition.onresult = (event) => {
                        const command = event.results[0][0].transcript.toLowerCase();
                        this.processVoiceCommand(command);
                    };
                    
                    recognition.start();
                    console.log('üó£Ô∏è Voice control activated - try saying "show cathedral" or "breathing guide"');
                } else {
                    console.log('Voice recognition not supported in this browser');
                }
            }

            processVoiceCommand(command) {
                if (command.includes('cathedral') || command.includes('home')) {
                    this.safeExit();
                } else if (command.includes('breathing') || command.includes('ground')) {
                    this.toggleBreathingGuide();
                } else if (command.includes('memory') || command.includes('help')) {
                    this.showMemorySupport();
                } else if (command.includes('normal')) {
                    this.setView('normal');
                } else if (command.includes('fractal')) {
                    this.setView('fractal');
                }
            }

            toggleBreathingGuide() {
                const guide = document.getElementById('breathing-guide');
                const btn = document.getElementById('grounding');
                
                if (guide.style.display === 'flex') {
                    guide.style.display = 'none';
                    btn.classList.remove('active');
                } else {
                    guide.style.display = 'flex';
                    btn.classList.add('active');
                }
            }

            safeExit() {
                // Gentle return to cathedral center
                this.activeKeys.clear();
                this.fractalDepth = 1;
                this.currentView = 'normal';
                
                document.querySelectorAll('.piano-key').forEach(key => key.classList.remove('active'));
                document.querySelectorAll('.toggle-btn').forEach(btn => btn.classList.remove('active'));
                document.getElementById('normal-view').classList.add('active');
                
                this.updateNodeStates();
                console.log('üè† Returned to safe cathedral center');
            }

            handleKeyboard(e) {
                // ESC always returns to safe exit
                if (e.key === 'Escape') {
                    this.safeExit();
                }
                
                // Piano key shortcuts
                const keyMap = {
                    'c': 'cathedral',
                    'd': 'stone-grimoire', 
                    'e': 'tesseract-bridge',
                    'f': 'cosmogenesis',
                    'g': 'luxcrux'
                };
                
                if (keyMap[e.key.toLowerCase()]) {
                    const keyElement = document.querySelector(`[data-repo="${keyMap[e.key.toLowerCase()]}"]`);
                    if (keyElement) this.toggleKey(keyElement);
                }
            }

            autoSave() {
                const state = {
                    activeKeys: Array.from(this.activeKeys),
                    currentView: this.currentView,
                    fractalDepth: this.fractalDepth,
                    activeFusionGuide: this.activeFusionGuide || null,
                    master33Mode: this.master33Mode || false,
                    timestamp: new Date().toISOString(),
                    lastActivity: "Exploring consciousness connections safely",
                    // Never save personal information - only interface state
                    privacyNote: "Personal details always protected - only exploring through Rebecca Respawn avatar"
                };
                
                localStorage.setItem('cathedral-state', JSON.stringify(state));
                console.log('üíæ State auto-saved for memory support (personal info always protected)');
            }

            // Master 33 Fusion Guide Activation System
            activateFusionGuide(guideName) {
                // Clear previous fusion guide
                document.querySelectorAll('.fusion-btn').forEach(btn => btn.classList.remove('active'));
                document.getElementById(`${guideName}-fusion`).classList.add('active');
                
                this.activeFusionGuide = guideName;
                
                const fusionWisdom = {
                    leonardo: {
                        message: "üé® Leonardo da Vinci fusion activated: Art meets Science meets Engineering. Your creative explorations now integrate technical precision with artistic vision. Notice how each repository reveals both aesthetic beauty and functional innovation.",
                        filter: "sepia(0.3) contrast(1.2)"
                    },
                    jung: {
                        message: "üîÆ Carl Jung fusion activated: Psychology meets Mysticism meets Collective Unconscious. Your explorations now reveal archetypal patterns and shadow integration opportunities. Each piano key accesses different aspects of your psyche.",
                        filter: "hue-rotate(60deg) saturate(1.3)"
                    },
                    fuller: {
                        message: "‚ö° Buckminster Fuller fusion activated: Systems Thinking meets Poetic Architecture. Your Cathedral becomes a living geodesic dome of consciousness. Every connection reveals comprehensive anticipatory design science.",
                        filter: "brightness(1.2) contrast(1.1)"
                    },
                    morrison: {
                        message: "üÉè Grant Morrison fusion activated: Pop Culture meets Chaos Magic meets Reality Hacking. Your repositories become comic book panels in an infinite narrative. Each exploration rewrites consensus reality through creative insurgency.",
                        filter: "saturate(1.5) hue-rotate(300deg)"
                    },
                    mckenna: {
                        message: "üçÑ Terence McKenna fusion activated: Language meets Technology meets Consciousness. Your system becomes a linguistic DMT machine creating novel connections. Each session births new words for ineffable experiences.",
                        filter: "hue-rotate(120deg) saturate(1.4) brightness(1.1)"
                    }
                };
                
                const guide = fusionWisdom[guideName];
                if (guide) {
                    this.showFusionMessage(guide.message);
                    this.canvas.style.filter = guide.filter;
                    console.log(`üåü ${guideName.toUpperCase()} fusion guide activated - Creative synthesis enhanced`);
                }
            }

            activateMaster33Mode() {
                this.master33Mode = !this.master33Mode;
                const btn = document.getElementById('master33-mode');
                
                if (this.master33Mode) {
                    btn.classList.add('active');
                    btn.textContent = 'üåü M33 ON';
                    
                    this.showFusionMessage("üåü MASTER NUMBER 33 MODE ACTIVATED: You are now in teaching consciousness. Your creative explorations generate wisdom that serves the collective. Every discovery becomes medicine for others with complex minds. Your 3/5 Manifesting Generator energy creates universal solutions from personal experimentation.");
                    
                    // Add special M33 visual effects
                    document.body.style.setProperty('--cathedral-gold', '#ffd700');
                    document.body.style.setProperty('--octarine', '#ff00ff');
                    
                    console.log('üåü MASTER 33 TEACHING MODE: Intuitive gifts transforming into creative mastery');
                } else {
                    btn.classList.remove('active');
                    btn.textContent = 'üåü Master 33';
                    
                    // Reset to normal colors
                    document.body.style.setProperty('--cathedral-gold', '#d4af37');
                    document.body.style.setProperty('--octarine', '#9333ea');
                    
                    console.log('üíé Master 33 mode deactivated - returning to personal exploration');
                }
            }

            showFusionMessage(message) {
                const prompt = document.getElementById('memory-prompt');
                document.getElementById('memory-text').textContent = message;
                prompt.style.display = 'block';
                
                // Auto-hide after 20 seconds for fusion messages (longer for processing)
                setTimeout(() => {
                    if (prompt.style.display === 'block') {
                        prompt.style.display = 'none';
                    }
                }, 20000);
            }

            loadSavedState() {
                const saved = localStorage.getItem('cathedral-state');
                if (saved) {
                    const state = JSON.parse(saved);
                    this.activeKeys = new Set(state.activeKeys || []);
                    this.currentView = state.currentView || 'normal';
                    this.fractalDepth = state.fractalDepth || 1;
                    
                    // Restore UI state
                    state.activeKeys?.forEach(repo => {
                        const keyElement = document.querySelector(`[data-repo="${repo}"]`);
                        if (keyElement) keyElement.classList.add('active');
                    });
                    
                    console.log('üíú Previous state restored for memory support');
                }
            }

            // Update voices display when new voice is activated
            updateVoicesDisplay() {
                if (!window.archetypalVoices) return;
                
                const display = document.getElementById('voicesDisplay');
                const recentVoices = window.archetypalVoices.displayRecentVoices();
                
                if (recentVoices) {
                    display.innerHTML = recentVoices;
                    // Auto-scroll to latest voice
                    display.scrollTop = display.scrollHeight;
                }
            }
        }

        // Global helper functions
        function showMemoryDetails() {
            const saved = localStorage.getItem('cathedral-state');
            if (saved) {
                const state = JSON.parse(saved);
                alert(`üíú Last visit: ${new Date(state.timestamp).toLocaleString()}\nYou were: ${state.lastActivity}\nActive guides: ${state.activeKeys?.join(', ') || 'Cathedral center'}`);
            }
        }

        // Archetypal Voices Control Functions
        function toggleVoicesPanel() {
            const panel = document.getElementById('voicesPanel');
            panel.style.display = panel.style.display === 'none' ? 'block' : 'none';
        }

        function clearVoices() {
            if (window.archetypalVoices) {
                window.archetypalVoices.voiceLog = [];
                document.getElementById('voicesDisplay').innerHTML = 
                    '<p class="voices-intro">üèõÔ∏è CATHEDRAL: "I listen for the voices of wisdom that dwell within..."</p>';
            }
        }

        function downloadConversation() {
            if (window.archetypalVoices) {
                const conversation = window.archetypalVoices.getCurrentConversation();
                const blob = new Blob([conversation], { type: 'text/plain' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `cathedral-voices-${new Date().toISOString().slice(0, 10)}.txt`;
                a.click();
                URL.revokeObjectURL(url);
            }
        }

        // Initialize the map when page loads
        window.addEventListener('DOMContentLoaded', () => {
            // Initialize archetypal voices system
            if (typeof ArchetypalVoices !== 'undefined') {
                window.archetypalVoices = new ArchetypalVoices();
                console.log('üéµ Archetypal Voices system initialized');
            }
            
            const cathedral = new CathedralMap();
            cathedral.loadSavedState();
            
            console.log('üèõÔ∏è Cathedral Connection Map initialized');
            console.log('üíú Memory support and accessibility features active');
            console.log('üéπ Click piano keys or use voice commands');
            console.log('‚å®Ô∏è Press ESC anytime for safe exit to cathedral center');
            console.log('üó£Ô∏è Try voice commands: "show cathedral", "breathing guide", "memory help"');
            console.log('üéµ Click "Listen to Archetypal Voices" to see the living conversation');
        });
    </script>
</body>
</html>