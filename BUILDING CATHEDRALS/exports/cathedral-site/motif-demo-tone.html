<!doctype html><meta charset="utf-8"/><title>Cathedral Tone Motif Demo</title><link rel="stylesheet" href="./style.css"/><body><h1>Motif Demo (Tone.js)</h1><p>Layered audition using Tone.js. Click <strong>Enable Audio</strong> first (browser gesture). Loop is optional.</p><div style="margin:.5rem 0;"><button id="start">Enable Audio</button> <label style="margin-left:1rem;font-size:.9rem"><input type="checkbox" id="loop"/> loop</label></div><div id="motifs" style="margin-top:1rem;display:flex;flex-wrap:wrap;gap:.5rem"></div><pre id="details"></pre><script src="https://unpkg.com/tone@15.0.4/build/Tone.js"></script><script type="module">import { loadReference } from './loader.js';
const { audioMap } = await loadReference('.');
const Tone = window.Tone;
const root = document.getElementById('motifs');
const details = document.getElementById('details');
let current = []; let loopFlag=false; const loopChk=document.getElementById('loop'); loopChk.addEventListener('change',()=>loopFlag=loopChk.checked);
function buildVoice(def){ const t=def.type||'synth'; const reverb=new Tone.Reverb({decay:2.5,wet:0.25}).toDestination(); let inst; switch(t){case 'fm': inst=new Tone.FMSynth(); break; case 'mono': inst=new Tone.MonoSynth(); break; case 'drone': inst=new Tone.Oscillator('A2','sine'); break; case 'percussion': inst=new Tone.MembraneSynth(); break; case 'ensemble': inst=new Tone.PolySynth(Tone.Synth,{maxPolyphony:8}); break; default: inst=new Tone.Synth();} if(inst.start){ inst.connect(reverb); } else { inst.connect(reverb); } return inst; }
function schedule(voice, notes, offset){ const now=Tone.now()+offset; notes.forEach((n,i)=>{ if(voice.triggerAttackRelease) voice.triggerAttackRelease(n,'8n', now + i*0.25); }); if(voice.start){ voice.start(now).stop(now+2); }
}
async function playMotif(m){ if(Tone.context.state!=='running') await Tone.start(); current.forEach(v=>{try{v.dispose();}catch{}}); current=[]; const ids=(m.palette||m.layers||[]).slice(0,3); const baseNotes=['C4','E4','G4']; ids.forEach((pid,pi)=>{ const def=audioMap.instrumentPalettes?.[pid]||{}; const voice=buildVoice(def); current.push(voice); const notes=(def.notes&&def.notes.length?def.notes:baseNotes).map(n=> n.replace(/4/, 4+pi)); schedule(voice, notes, 0); }); details.textContent=JSON.stringify(m,null,2); if(loopFlag) setTimeout(()=>playMotif(m), 2400); }
document.getElementById('start').onclick= async ()=>{ await Tone.start(); document.getElementById('start').disabled=true; };
if(audioMap){ audioMap.motifs.forEach(m=>{ const b=document.createElement('button'); b.textContent=m.id; b.style.padding='.4rem .7rem'; b.style.background='#222'; b.style.border='1px solid #444'; b.style.color='#ffd479'; b.style.cursor='pointer'; b.onclick=()=>playMotif(m); root.appendChild(b); }); }
</script>